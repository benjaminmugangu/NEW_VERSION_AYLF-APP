// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Enums

enum UserRole {
  NATIONAL_COORDINATOR
  SITE_COORDINATOR
  SMALL_GROUP_LEADER
  MEMBER
}

enum UserStatus {
  active
  inactive
}

enum MemberGender {
  male
  female
}

enum MemberType {
  student
  non_student
}

enum ActivityStatus {
  planned
  in_progress
  delayed
  executed
  canceled
}

enum ActivityLevel {
  national
  site
  small_group
}

enum ReportStatus {
  pending
  submitted
  approved
  rejected
}

enum TransactionType {
  income
  expense
}

enum AllocationStatus {
  planned
  completed
}

enum ActivityCategory {
  spiritual
  outreach
  community
  training
}

enum ActivityTypeEnum {
  small_group_meeting
  conference
  apostolat
  deuil
  other
}

enum NotificationType {
  REPORT_APPROVED
  REPORT_REJECTED
  ALLOCATION_RECEIVED
  ACTIVITY_REMINDER
  BUDGET_ALERT
  NEW_REPORT
  USER_INVITED
}

// Models

model Profile {
  id     String     @id // Kinde User ID
  email  String     @unique
  name   String
  role   UserRole
  status UserStatus @default(active)
  avatarUrl String? @map("avatar_url")

  // Relations
  siteId String? @map("site_id")
  site   Site?   @relation("SiteMembers", fields: [siteId], references: [id])

  smallGroupId String?     @map("small_group_id")
  smallGroup   SmallGroup? @relation("GroupMembers", fields: [smallGroupId], references: [id])

  // Leadership roles
  ledSmallGroup    SmallGroup? @relation("GroupLeader")
  logisticForGroup SmallGroup? @relation("GroupLogistics")
  financeForGroup  SmallGroup? @relation("GroupFinance")

  managedSite Site? @relation("SiteCoordinator")

  // Content ownership
  createdActivities    Activity[]
  submittedReports     Report[]               @relation("ReportSubmitter")
  reviewedReports      Report[]               @relation("ReportReviewer")
  recordedTransactions FinancialTransaction[] @relation("RecordedBy")
  approvedTransactions FinancialTransaction[] @relation("ApprovedTransactions") // NEW
  allocatedFunds       FundAllocation[]
  certificates         Certificate[]
  auditLogs            AuditLog[] // NEW
  closedPeriods        AccountingPeriod[] // NEW
  notifications        Notification[] // NEW
  members              Member[]

  mandateStartDate DateTime? @map("mandate_start_date")
  mandateEndDate   DateTime? @map("mandate_end_date")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  @@map("profiles")
}

model Site {
  id      String @id @default(uuid())
  name    String
  city    String
  country String

  coordinatorId String?  @unique @map("coordinator_id")
  coordinator   Profile? @relation("SiteCoordinator", fields: [coordinatorId], references: [id])

  // Relations
  members           Profile[]              @relation("SiteMembers") // Staff members
  registeredMembers Member[] // Regular members
  smallGroups       SmallGroup[]
  activities        Activity[]
  transactions      FinancialTransaction[]
  allocations       FundAllocation[]
  allocationsFrom   FundAllocation[]       @relation("AllocationsFrom") // NEW - for Site → Group allocations
  reports           Report[]
  invitations       UserInvitation[]
  inventoryItems    InventoryItem[] // NEW - for Inventory Management
  inventoryMovements InventoryMovement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("sites")
}

model SmallGroup {
  id   String @id @default(uuid())
  name String

  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // Leadership
  leaderId String?  @unique @map("leader_id")
  leader   Profile? @relation("GroupLeader", fields: [leaderId], references: [id])

  logisticsAssistantId String?  @unique @map("logistics_assistant_id")
  logisticsAssistant   Profile? @relation("GroupLogistics", fields: [logisticsAssistantId], references: [id])

  financeAssistantId String?  @unique @map("finance_assistant_id")
  financeAssistant   Profile? @relation("GroupFinance", fields: [financeAssistantId], references: [id])

  // Meeting details
  meetingDay      String? @map("meeting_day")
  meetingTime     String? @map("meeting_time")
  meetingLocation String? @map("meeting_location")

  // Relations
  members           Profile[]              @relation("GroupMembers") // Staff members
  registeredMembers Member[] // Regular members
  activities        Activity[]
  transactions      FinancialTransaction[]
  allocations       FundAllocation[]
  reports           Report[]
  invitations       UserInvitation[]
  inventoryMovements InventoryMovement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("small_groups")
}

model Member {
  id       String       @id @default(uuid())
  name     String
  gender   MemberGender
  type     MemberType
  phone    String?
  email    String?
  joinDate DateTime     @map("join_date")

  level ActivityLevel

  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  smallGroupId String?     @map("small_group_id")
  smallGroup   SmallGroup? @relation(fields: [smallGroupId], references: [id], onDelete: Cascade)

  userId String?  @map("user_id")
  user   Profile? @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("members")
}

model ActivityType {
  id          String           @id @default(uuid())
  name        String
  category    ActivityCategory
  description String?

  activities Activity[]
  reports    Report[]

  @@map("activity_types")
}

model Activity {
  id       String         @id @default(uuid())
  title    String
  thematic String
  date     DateTime
  status   ActivityStatus @default(planned)
  level    ActivityLevel

  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  smallGroupId String?     @map("small_group_id")
  smallGroup   SmallGroup? @relation(fields: [smallGroupId], references: [id], onDelete: Cascade)

  activityTypeId String       @map("activity_type_id")
  activityType   ActivityType @relation(fields: [activityTypeId], references: [id])

  // New enum-based type field
  activityTypeEnum ActivityTypeEnum? @map("activity_type_enum")

  participantsCountPlanned Int? @map("participants_count_planned")

  createdById String  @map("created_by")
  createdBy   Profile @relation(fields: [createdById], references: [id])

  // Relations
  reports               Report[]
  financialTransactions FinancialTransaction[] // NEW - transactions linked to this activity

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("activities")
}

model Report {
  id             String        @id @default(uuid())
  title          String
  activityDate   DateTime      @map("activity_date")
  submissionDate DateTime      @default(now()) @map("submission_date")
  level          ActivityLevel
  status         ReportStatus  @default(pending)

  content                   String  @db.Text
  thematic                  String
  speaker                   String?
  moderator                 String?
  girlsCount                Int?    @map("girls_count")
  boysCount                 Int?    @map("boys_count")
  participantsCountReported Int?    @map("participants_count_reported")
  totalExpenses             Float?  @map("total_expenses")
  currency                  String?
  financialSummary          String? @map("financial_summary") @db.Text
  reviewNotes               String? @map("review_notes") @db.Text

  // JSON fields for arrays
  images      Json? // Array<{ name: string; url: string }>
  attachments Json? // string[]

  // Relations
  submittedById String  @map("submitted_by")
  submittedBy   Profile @relation("ReportSubmitter", fields: [submittedById], references: [id])

  reviewedById    String?   @map("reviewed_by")
  reviewedBy      Profile?  @relation("ReportReviewer", fields: [reviewedById], references: [id])
  reviewedAt      DateTime? @map("reviewed_at")
  rejectionReason String?   @map("rejection_reason") // Reason for rejection

  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  smallGroupId String?     @map("small_group_id")
  smallGroup   SmallGroup? @relation(fields: [smallGroupId], references: [id], onDelete: Cascade)

  activityTypeId String       @map("activity_type_id")
  activityType   ActivityType @relation(fields: [activityTypeId], references: [id])

  activityId String?   @map("activity_id")
  activity   Activity? @relation(fields: [activityId], references: [id], onDelete: Cascade)

  linkedTransactions FinancialTransaction[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("reports")
}

model FinancialTransaction {
  id          String          @id @default(uuid())
  date        DateTime
  description String
  amount      Float
  type        TransactionType
  category    String

  // Entity Links
  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  smallGroupId String?     @map("small_group_id")
  smallGroup   SmallGroup? @relation(fields: [smallGroupId], references: [id], onDelete: Cascade)

  recordedById String  @map("recorded_by")
  recordedBy   Profile @relation("RecordedBy", fields: [recordedById], references: [id])

  attachments Json? // string[]

  // Workflow & Approval (NEW)
  status       String    @default("approved") // 'draft' | 'submitted' | 'approved' | 'rejected'
  approvedById String?   @map("approved_by_id")
  approvedBy   Profile?  @relation("ApprovedTransactions", fields: [approvedById], references: [id])
  approvedAt   DateTime? @map("approved_at")

  // Context Links (NEW)
  relatedReportId String? @map("related_report_id")
  relatedReport   Report? @relation(fields: [relatedReportId], references: [id], onDelete: Cascade)

  relatedActivityId String?   @map("related_activity_id")
  relatedActivity   Activity? @relation(fields: [relatedActivityId], references: [id], onDelete: Cascade)

  // Reversal Support (NEW)
  isReversalOfId String?                @map("is_reversal_of_id")
  isReversalOf   FinancialTransaction?  @relation("TransactionReversal", fields: [isReversalOfId], references: [id], onDelete: SetNull)
  reversals      FinancialTransaction[] @relation("TransactionReversal")

  // Proof (NEW)
  proofUrl String? @map("proof_url")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("transactions")
}

model FundAllocation {
  id             String           @id @default(uuid())
  amount         Float
  allocationDate DateTime         @map("allocation_date")
  goal           String
  source         String
  status         AllocationStatus
  notes          String?

  // Hybrid Allocation Support (NEW)
  allocationType String  @default("hierarchical") @map("allocation_type")
  // Values: 'hierarchical' (NC → Site OR SC → Group) or 'direct' (NC → Group bypass)
  
  bypassReason   String? @map("bypass_reason")
  // Required when allocationType = 'direct'. Min 20 characters.
  // Justification for why NC is bypassing the Site Coordinator.

  // Proof (NEW)
  proofUrl String? @map("proof_url") // URL to transfer proof in Supabase

  allocatedById String  @map("allocated_by_id")
  allocatedBy   Profile @relation(fields: [allocatedById], references: [id])

  // Source tracking (NEW) - for Site → Group allocations
  fromSiteId String? @map("from_site_id")
  fromSite   Site?   @relation("AllocationsFrom", fields: [fromSiteId], references: [id])

  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  smallGroupId String?     @map("small_group_id")
  smallGroup   SmallGroup? @relation(fields: [smallGroupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("fund_allocations")
}

model UserInvitation {
  id    String   @id @default(uuid())
  email String   @unique
  role  UserRole

  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  smallGroupId String?     @map("small_group_id")
  smallGroup   SmallGroup? @relation(fields: [smallGroupId], references: [id], onDelete: Cascade)

  token  String @unique @default(uuid())
  status String @default("pending") // pending, accepted, expired

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  expiresAt DateTime @default(dbgenerated("NOW() + INTERVAL '7 days'")) @map("expires_at")

  mandateStartDate DateTime? @map("mandate_start_date")
  mandateEndDate   DateTime? @map("mandate_end_date")

  @@index([token])
  @@index([expiresAt])
  @@map("user_invitations")
}

model Certificate {
  id               String   @id @default(uuid())
  profileId        String   @map("profile_id")
  profile          Profile  @relation(fields: [profileId], references: [id])
  role             String
  mandateStartDate DateTime @map("mandate_start_date")
  mandateEndDate   DateTime @map("mandate_end_date")
  pdfUrl           String   @map("pdf_url")
  generatedAt      DateTime @default(now()) @map("generated_at")
  downloadCount    Int      @default(0) @map("download_count")

  @@index([profileId])
  @@map("certificates")
}

// ============================================
// AUDIT LOG - Complete Traceability
// ============================================
model AuditLog {
  id String @id @default(uuid())

  // Who performed the action
  actorId String  @map("actor_id")
  actor   Profile @relation(fields: [actorId], references: [id], onDelete: Cascade)

  // What was done
  action String // 'create' | 'update' | 'approve' | 'reject' | 'complete' | 'reverse' | 'delete'

  // On which entity
  entityType String // 'FundAllocation' | 'FinancialTransaction' | 'Report' | 'Activity'
  entityId   String @map("entity_id")

  // Context
  metadata Json? // Stores before/after snapshots, comments, reasons

  // Technical details
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([entityType, entityId])
  @@index([actorId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// 4. ACCOUNTING PERIODS
// ============================================
model AccountingPeriod {
  id String @id @default(uuid())

  type      String // 'month' | 'quarter' | 'year'
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  status     String    @default("open") // 'open' | 'closed'
  closedAt   DateTime? @map("closed_at")
  closedById String?   @map("closed_by_id")
  closedBy   Profile?  @relation(fields: [closedById], references: [id])

  // Snapshot at closing
  snapshotData Json? @map("snapshot_data") // Stores balances per entity at closing

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([startDate, endDate])
  @@map("accounting_periods")
}

// ============================================
// 5. INVENTORY SYSTEM
// ============================================
model InventoryItem {
  id String @id @default(uuid())

  name        String
  description String?
  category    String? // 'equipment' | 'supplies' | 'furniture'
  unit        String? // 'piece' | 'box' | 'kg'

  // Ownership
  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)

  movements InventoryMovement[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("inventory_items")
}

model InventoryMovement {
  id String @id @default(uuid())

  itemId String        @map("item_id")
  item   InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  date      DateTime
  direction String // 'in' (purchase/reception) | 'out' (usage/disposal)
  quantity  Decimal
  reason    String? // Description or justification

  // Links to financial records
  relatedTransactionId String? @map("related_transaction_id")
  relatedReportId      String? @map("related_report_id")

  // Context
  siteId       String? @map("site_id")
  site         Site?   @relation(fields: [siteId], references: [id], onDelete: Cascade)
  smallGroupId String? @map("small_group_id")
  smallGroup   SmallGroup? @relation(fields: [smallGroupId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([itemId, date])
  @@map("inventory_movements")
}

// ============================================
// 6. NOTIFICATIONS SYSTEM
// ============================================

model Notification {
  id        String           @id @default(uuid())
  userId    String           @map("user_id")
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now()) @map("created_at")

  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@map("notifications")
}

// ============================================
// 7. IDEMPOTENCY KEYS (Offline Sync)
// ============================================

model IdempotencyKey {
  key        String   @id
  response   Json
  createdAt  DateTime @default(now()) @map("created_at")
  lockedAt   DateTime @default(now()) @map("locked_at") // For concurrent request locking

  @@map("idempotency_keys")
}
